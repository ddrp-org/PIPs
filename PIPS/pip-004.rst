PIP-4: Synchronization Protocol
===============================

.. contents:: Table of Contents
   :local:

Overview
########

Once two DDRP nodes are connected, they can begin synchronizing blob updates with one another. Since DDRP has no global consensus mechanism, a node is considered "in-sync" when a majority of its peers have no more updates to share.

Concept
#######

At a high level, DDRP's synchronization protocol operates as follows:

1. A node receives an update notification from one or more of its peers.
2. The node requests the base of the blob's Merkle tree from one or more of its peers.
3. The node requests the sectors whose hashes in the tree base differ from those stored by the requesting peer.
4. The node gossips the update notification to its peers.

Note that the process involves an additional step when nodes connect to the network for the first time. This process is covered in a dedicated section.

To keep track of changes to blobs, DDRP uses a timestamp-based versioning system. When a user updates their blob, they sign both the current timestamp as well as the updated blob's Merkle root. This allows nodes to reject stale updates or updates that happen too often.

Update Notifications
####################

Nodes receive notification of a blob update in one of two ways: from its peers via an ``Update`` message, or locally following a CLI-initiated update.

The ``Update`` Message
**********************

``Update`` messages have the following schema. All fields MUST be set:

#. ``type``: ``0x04``
#. Data:

    #. ``name``: ``NameRef`` (See `PIP-1`_)
    #. ``timestamp``: ``Time``
    #. ``merkle_root``: ``[32]byte``
    #. ``reserved``: ``[32]byte``
    #. ``signature``: ``Signature``

The ``timestamp`` field represents the timestamp of the blob's update.

The ``merkle_root`` field represents the blob's Merkle root post-update.

The ``reserved`` field is reserved for future use. It SHOULD be set to all zeroes. The ``reserved`` field is used as part of the blob signature generation process.

The ``signature`` field represents the signature of the blob's owner over the blob's timestamp and Merkle root.

Nodes receiving an ``Update`` message:

- MUST disconnect from nodes that send an invalid signature.
- MUST ignore ``Update`` messages with a ``timestamp`` value that precedes the referenced blob's ``timestamp``.
- MUST begin the sector synchronization process if the ``timestamp`` value proceeds the referenced blob's ``timestamp``.
- SHOULD ignore the ``Update`` message if the ``timestamp`` value is within the one hour window following the referenced blob's ``timestamp``.
- MUST resolve the provided name to a DDRP key on the Handshake blockchain in order to verify the provided ``signature``.

Sector Synchronization Process
******************************

We will describe this process from the perspective of two nodes, Alice and Bob, however in practice sector synchronization SHOULD be carried out among a group of peers. We will describe multiple-peer strategies after describing the protocol itself. The protocol works as follows, assuming that Bob sent Alice the ``Update`` message:

The ``TreeBaseReq`` Message
###########################

The first step in the synchronization process is for Alice to request a tree base from Bob by sending a ``TreeBaseReq`` message. It is structured as follows. All fields MUST be set:

#. ``type``: ``0x05``
#. Data:

#. ``name``: ``NameRef`` (See `PIP-1`_)

The ``TreeBaseRes`` Message
###########################

Once Bob receives the ``TreeBaseReq`` message, he responds with a ``TreeBaseRes`` message. The ``TreeBaseRes`` message is structured as follows, and all fields MUST be set:

#. ``type``: ``0x06``
#. Data:

   #. ``name``: ``NameRef`` (See `PIP-1`_)
	 #. ``tree_base``: ``[256][32]byte``

The ``tree_base`` field represents the base of the Merkle tree as described in `PIP-3`_.

Nodes receiving the ``TreeBaseRes`` message:

- MUST verify the ``tree_base`` against the ``merkle_root`` received in the ``Update`` message.

The ``SectorReq`` and ``SectorRes`` Messages
############################################

With the tree base in hand, Alice begins requesting sector data from Bob for each sector whose hash differs from the ones described in the tree base. She does this by sending ``SectorReq`` messages with the following structure:

#. ``type``: ``0x07``
#. Data:

   #. ``name``: ``NameRef`` (See `PIP-1`_)
	 #. ``sector_id``: ``uint16``
   #. ``last_sector_hash``: ``[32]byte``

The ``sector_id`` represents the ID of the sector whose data is being requested.

The ``last_sector_hash`` represents the last hash of the sector from the requestor. If it is set to all zeroes, it represents the request is made for the entire sector.

All fields MUST be set.

Upon receipt of Alice's ``SectorReq``, Bob can calculate the chunks that Alice doesn't have by regenerating the leaf hash from the first chunk and then compare it with ``last_sector_hash`` as it iterates forward till the end of the sector. A cache of ``[256][32]byte`` per sector (``[256][32]byte`` per blob) can be used to store a list of ``leaf`` to optimize read time. If ``last_sector_hash`` is not found, Bob can respond return ``SectorRes`` with the entire sector.

Bob responds with a ``SectorRes`` message with the following structure:

#. ``type``: ``0x08``
#. Data:

   #. ``name``: ``NameRef`` (See `PIP-1`_)
	 #. ``sector_id``: ``uint16``
   #. ``last_sector_hash``: ``[32]byte``
	 #. ``sector``: ``up to [256]byte``

The ``sector_id`` field represents the ID of the sector whose data is being returned.

The ``last_sector_hash`` represents the last hash of the sector from the requestor. If it is set to all zeroes, it represents the response contains the entire sector.

The ``sector`` field represents the returned sector's data. If ``last_sector_hash`` is set, only the delta change since ``last_sector_hash`` should be returned.

Nodes receiving ``SectorRes`` messages:

- MUST verify the ``sector`` and ``last_sector_hash`` (if necessary) field against the validated ``tree_base`` received in the ``TreeBaseRes`` message.

Nodes in general:

- MUST NOT send ``SectorRes`` messages for names for which they have no data.

Update Gossip
#############

Nodes MUST send ``Update`` messages to their peers once they complete the sector synchronization process. Nodes SHOULD filter out peers that don't need the ``Update`` message, such as those that started the sending node's synchronization process.

Initial Synchronization Protocol
################################

When a DDRP node joins the network for the first time, it executes the following protocol to bootstrap blob data:

1. The node traverses the Handshake blockchain from genesis to head, and aggregates all TLDs that contain ``DDRPKEY`` ``TXT`` records.
2. For each TLD with a ``DDRPKEY`` record, the node sends an ``UpdateReq`` message to its peers.
3. The node's peers respond with an ``Update`` message that contains the information the sending node needs to begin the sector synchronization protocol.
4. The node begins sector synchronization as described above.

See below for how the ``UpdateReq`` message is structured.

The ``UpdateReq`` Message
*************************

#. ``type``: ``0x0b``
#. Data:

   #. ``name``: ``NameRef``


Authors
#######

- `mslipper`_
- `chikeichan`_

.. _mslipper: https://github.com/mslipper
.. _chikeichan: https://github.com/chikeichan
.. _PIP-1: /spec/pip-001.html
.. _PIP-3: /spec/pip-003.html
